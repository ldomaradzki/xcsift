# Usage

Complete CLI reference for xcsift commands and flags.

## Overview

xcsift reads from stdin and outputs structured build results. Always redirect stderr to stdout with `2>&1` to capture all compiler output.

## Basic Syntax

```bash
xcodebuild [flags] 2>&1 | xcsift [options]
swift build 2>&1 | xcsift [options]
swift test 2>&1 | xcsift [options]
```

## Output Format Options

### `--format`, `-f`

Select output format: `json` (default), `toon`, or `github-actions`.

```bash
# JSON (default)
xcodebuild build 2>&1 | xcsift

# TOON (30-60% fewer tokens)
xcodebuild build 2>&1 | xcsift --format toon
xcodebuild build 2>&1 | xcsift -f toon

# GitHub Actions annotations only
xcodebuild build 2>&1 | xcsift -f github-actions
```

## Warning Options

### `--warnings`, `-w`

Include detailed warnings array in output. By default, only warning count is shown in summary.

```bash
# Show detailed warnings
xcodebuild build 2>&1 | xcsift --warnings
swift build 2>&1 | xcsift -w
```

Includes both compiler warnings and runtime warnings (SwiftUI, swift-issue-reporting). Each warning has a `type` field:
- `compile` — Standard compiler warnings
- `swiftui` — SwiftUI runtime warnings (e.g., "Publishing changes from background threads")
- `runtime` — Custom runtime warnings

Warnings are automatically deduplicated — identical entries appear only once.

### `--Werror`, `-W`

Treat warnings as errors. Build fails if any warnings are present.

```bash
xcodebuild build 2>&1 | xcsift --Werror
swift build 2>&1 | xcsift -W
```

## Quiet Mode

### `--quiet`, `-q`

Suppress output when build succeeds with no warnings or errors.

```bash
xcodebuild build 2>&1 | xcsift --quiet
swift build 2>&1 | xcsift -q
```

## Test Analysis Options

### `--slow-threshold`

Set threshold in seconds for slow test detection. Tests exceeding this duration are flagged.

```bash
# Flag tests slower than 1 second
swift test 2>&1 | xcsift --slow-threshold 1.0

# Flag tests slower than 500ms
xcodebuild test 2>&1 | xcsift --slow-threshold 0.5

# Combine with TOON format
swift test 2>&1 | xcsift -f toon --slow-threshold 2.0
```

When enabled, output includes:
- `summary.slow_tests` — count of slow tests
- `slow_tests[]` — array of slow test objects with `test` name and `duration` in seconds

### Flaky Test Detection

Flaky tests are automatically detected when a test both passes AND fails in the same run (common in retry scenarios). No flag needed — detection is automatic.

When detected, output includes:
- `summary.flaky_tests` — count of flaky tests
- `flaky_tests[]` — array of flaky test names

## Executable Options

### `--executable`, `-e`

Include executable targets generated by the build. Parses `RegisterWithLaunchServices` lines from xcodebuild output.

```bash
# Show executable targets
xcodebuild build 2>&1 | xcsift --executable
xcodebuild build 2>&1 | xcsift -e

# Combine with other flags
xcodebuild build 2>&1 | xcsift -e -w -f toon
```

When enabled, output includes:
- `summary.executables` — count of executable targets
- `executables[]` — array of executable objects with `path`, `name`, and `target`

Note: Duplicate executables (same path registered multiple times) are automatically deduplicated.

## Build Info Options

### `--build-info`

Include per-target build phases, timing, and dependencies in output.

```bash
# Basic build info
xcodebuild build 2>&1 | xcsift --build-info
swift build 2>&1 | xcsift --build-info

# Combine with other flags
xcodebuild build 2>&1 | xcsift -f toon --build-info -w
```

When enabled, output includes:
- `build_info.targets[]` — array of targets with build information
- `build_info.slowest_targets[]` — top 5 targets sorted by duration (descending)
- Each target contains:
  - `name` — target name
  - `duration` — build duration (e.g., "12.4s")
  - `phases[]` — build phases (CompileSwiftSources, Link, etc.)
  - `depends_on[]` — target dependencies (omitted when empty)

Supported phases:
- **xcodebuild**: `CompileSwiftSources`, `SwiftCompilation`, `CompileC`, `Link`, `CopySwiftLibs`, `PhaseScriptExecution`, `LinkAssetCatalog`, `ProcessInfoPlistFile`
- **SPM**: `Compiling`, `Linking`

## Coverage Options

### `--coverage`, `-c`

Enable code coverage output. Automatically converts `.profraw` (SPM) or `.xcresult` (xcodebuild) to JSON.

```bash
swift test --enable-code-coverage 2>&1 | xcsift --coverage
xcodebuild test -enableCodeCoverage YES 2>&1 | xcsift -c
```

### `--coverage-details`

Include per-file coverage breakdown. Default is summary-only (percentage only) for token efficiency.

```bash
swift test --enable-code-coverage 2>&1 | xcsift --coverage --coverage-details
```

### `--coverage-path`

Specify custom path to coverage data (optional, auto-detected by default).

```bash
swift test --enable-code-coverage 2>&1 | xcsift --coverage --coverage-path .build/arm64-apple-macosx/debug/codecov
```

## TOON Configuration

### `--toon-delimiter`

Set delimiter for TOON tabular format: `comma` (default), `tab`, or `pipe`.

```bash
xcodebuild build 2>&1 | xcsift -f toon --toon-delimiter tab
xcodebuild build 2>&1 | xcsift -f toon --toon-delimiter pipe
```

### `--toon-key-folding`

Enable key folding: `disabled` (default) or `safe`.

```bash
# Collapses {a:{b:{c:1}}} to a.b.c: 1
xcodebuild build 2>&1 | xcsift -f toon --toon-key-folding safe
```

### `--toon-flatten-depth`

Limit key folding depth (default: unlimited).

```bash
xcodebuild build 2>&1 | xcsift -f toon --toon-key-folding safe --toon-flatten-depth 3
```

## Configuration File Options

### `--init`

Generate a `.xcsift.toml` template in the current directory.

```bash
xcsift --init
```

Creates a commented template with all available options.

### `--config`

Use a specific configuration file instead of auto-detection.

```bash
xcodebuild build 2>&1 | xcsift --config ~/my-config.toml
```

If the specified file doesn't exist, xcsift fails with an error.

### Configuration File Search Order

When `--config` is not specified, xcsift searches for configuration files in this order:

1. `.xcsift.toml` in current working directory
2. `~/.config/xcsift/config.toml` in home directory

If no configuration file is found, CLI defaults are used.

### Priority

**CLI flags always override configuration file values.** For example:

```bash
# Config has format = "toon", but CLI overrides to JSON
xcodebuild build 2>&1 | xcsift -f json
```

See <doc:Configuration> for full documentation on configuration file format.

## Combined Examples

```bash
# TOON with warnings
swift build 2>&1 | xcsift -f toon -w

# TOON with coverage details
swift test --enable-code-coverage 2>&1 | xcsift -f toon -c --coverage-details

# All TOON options
xcodebuild test 2>&1 | xcsift -f toon --toon-delimiter pipe --toon-key-folding safe -w -c

# Slow test detection with coverage
swift test --enable-code-coverage 2>&1 | xcsift --slow-threshold 1.0 --coverage

# Full test analysis
xcodebuild test 2>&1 | xcsift -f toon --slow-threshold 0.5 -w -c

# Build with executable targets
xcodebuild build 2>&1 | xcsift -e -w -f toon

# Full build analysis
xcodebuild build 2>&1 | xcsift -f toon -e -w --build-info
```

## Exit Codes

- `0` — Build succeeded
- `1` — Build failed (errors, linker errors, or test failures)
- `1` — Build has warnings (when `--Werror` is used)
